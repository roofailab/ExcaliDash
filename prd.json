[
  {
    "category": "setup",
    "description": "Add API_KEYS env var to ExcaliDash backend .env.example and config",
    "steps": [
      "Open `~/projects/ExcaliDash/backend/.env.example`",
      "Add a new section after the existing optional feature flags: `# CI / API Key Authentication` with `# API_KEYS=` (comma-separated bcrypt-hashed keys)",
      "Open `~/projects/ExcaliDash/backend/src/config.ts` (or wherever `config` is exported from)",
      "Add `apiKeys: process.env.API_KEYS ? process.env.API_KEYS.split(',').map(k => k.trim()).filter(Boolean) : []` to the config object",
      "Verify TypeScript compilation succeeds: `cd ~/projects/ExcaliDash/backend && npx tsc --noEmit`"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Add API key validation utility to ExcaliDash backend",
    "steps": [
      "Create `~/projects/ExcaliDash/backend/src/auth/apiKey.ts`",
      "Import `bcrypt` (already a dependency in backend/package.json) and `config`",
      "Export `validateApiKey(plainKey: string): Promise<boolean>` — iterates `config.apiKeys`, calls `bcrypt.compare(plainKey, hashedKey)` for each, returns true on first match",
      "Export `API_KEY_HEADER = 'x-api-key'` constant",
      "Verify TypeScript compilation succeeds: `cd ~/projects/ExcaliDash/backend && npx tsc --noEmit`"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Add CI service account user lookup helper",
    "steps": [
      "In `~/projects/ExcaliDash/backend/src/auth/apiKey.ts`, export `getCiServiceAccountUser(prisma: PrismaClient): Promise<Express.Request['user']>`",
      "This function queries `prisma.user.findFirst({ where: { email: config.ciServiceAccountEmail } })` or a dedicated config field for the CI account email",
      "Add `CI_SERVICE_ACCOUNT_EMAIL` to config (env var) with a sensible default like `ci@excalidash.local`",
      "Add `CI_SERVICE_ACCOUNT_EMAIL` to `.env.example`",
      "Return the user shaped as `{ id, username, email, name, role }` matching the `req.user` interface in `middleware/auth.ts`",
      "If user not found, throw a descriptive error: `CI service account not found. Create a user with email ${config.ciServiceAccountEmail}`",
      "Verify TypeScript compilation succeeds"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Modify requireAuth middleware to check X-API-Key before JWT",
    "steps": [
      "Open `~/projects/ExcaliDash/backend/src/middleware/auth.ts`",
      "Import `validateApiKey`, `API_KEY_HEADER`, and `getCiServiceAccountUser` from `../auth/apiKey`",
      "In `requireAuth`, before the existing `extractToken()` call (after the authEnabled check), add API key check block:",
      "  1. Read `req.headers[API_KEY_HEADER]` as string",
      "  2. If header present: call `validateApiKey(apiKeyValue)`",
      "  3. If valid: call `getCiServiceAccountUser(prisma)`, attach to `req.user`, call `next()`, return",
      "  4. If invalid: return 401 `{ error: 'Unauthorized', message: 'Invalid API key' }`",
      "  5. If header absent: fall through to existing JWT logic (no change)",
      "Verify existing JWT auth flow is unchanged when X-API-Key header is absent",
      "Verify TypeScript compilation succeeds"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Modify optionalAuth middleware to check X-API-Key before JWT",
    "steps": [
      "In the same `~/projects/ExcaliDash/backend/src/middleware/auth.ts` file",
      "In `optionalAuth`, add the same API key check block before `extractToken()` (after authEnabled check)",
      "  1. If X-API-Key present and valid: attach CI service account user, call `next()`, return",
      "  2. If X-API-Key present and invalid: return 401 (do NOT silently skip — invalid key should always fail)",
      "  3. If absent: fall through to existing JWT logic",
      "Verify TypeScript compilation succeeds"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Add X-API-Key to CORS allowedHeaders",
    "steps": [
      "Open `~/projects/ExcaliDash/backend/src/index.ts`",
      "Find the `cors()` configuration around line 296-300 with `allowedHeaders` array",
      "Add `'X-API-Key'` to the `allowedHeaders` array (after existing entries)",
      "Verify TypeScript compilation succeeds"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Write unit tests for API key auth middleware",
    "steps": [
      "Create `~/projects/ExcaliDash/backend/src/auth/__tests__/apiKey.test.ts`",
      "Follow existing test patterns in the backend (vitest, see `vitest.config.ts`)",
      "Test `validateApiKey`: valid key returns true, invalid key returns false, empty API_KEYS config returns false",
      "Create `~/projects/ExcaliDash/backend/src/middleware/__tests__/auth-apikey.test.ts`",
      "Test requireAuth with valid X-API-Key header → 200, user attached",
      "Test requireAuth with invalid X-API-Key → 401",
      "Test requireAuth with no X-API-Key but valid JWT Bearer → 200 (fallthrough works)",
      "Test optionalAuth with valid X-API-Key → user attached",
      "Test optionalAuth with invalid X-API-Key → 401",
      "Run `cd ~/projects/ExcaliDash/backend && npx vitest run` and verify all tests pass"
    ],
    "passes": true
  },
  {
    "category": "setup",
    "description": "Scaffold packages/sync-diagrams workspace in ExcaliDash fork",
    "steps": [
      "Create directory `~/projects/ExcaliDash/packages/sync-diagrams/src/`",
      "Create `~/projects/ExcaliDash/packages/sync-diagrams/package.json` with name `@your-org/excalidash-sync`, version `0.1.0`, type `module`, bin entry `excalidash-sync` pointing to `dist/index.js`",
      "Add dependencies: `@excalidraw/mermaid-to-excalidraw`, `@excalidraw/excalidraw`",
      "Create `~/projects/ExcaliDash/packages/sync-diagrams/tsconfig.json` extending a base or standalone config targeting ES2022/Node16 module resolution, outDir `dist`, rootDir `src`",
      "Create stub `~/projects/ExcaliDash/packages/sync-diagrams/src/index.ts` that prints `excalidash-sync: ok` and exits 0",
      "Add `packages/*` to root `package.json` workspaces field (create root package.json if needed, since only package-lock.json exists at root currently)",
      "Run `cd ~/projects/ExcaliDash && npm install` and verify it resolves without errors",
      "Run `node ~/projects/ExcaliDash/packages/sync-diagrams/src/index.ts` (or `npx tsx`) and verify it prints `excalidash-sync: ok`"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Implement CLI argument parsing for sync-diagrams",
    "steps": [
      "Open `~/projects/ExcaliDash/packages/sync-diagrams/src/index.ts`",
      "Replace stub with CLI entry point using `parseArgs` from `node:util` (Node 18+ built-in, no extra deps)",
      "Parse flags: `--dir` (string, default `docs/diagrams`), `--config` (string, default `.excalidraw-sync.json`)",
      "Read env vars: `EXCALIDASH_URL` (required), `EXCALIDASH_API_KEY` (required)",
      "If required env vars missing, print error and exit 1",
      "Export parsed options as a typed config object for use by other modules",
      "Verify: run with `--help` or missing env vars → clear error message"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Implement manifest (sync.json) read/write module",
    "steps": [
      "Create `~/projects/ExcaliDash/packages/sync-diagrams/src/manifest.ts`",
      "Define TypeScript interfaces: `SyncManifest` (with `excalidashUrl`, `serviceAccount`, `collectionId`, `drawings` map) and `DrawingEntry` (with `drawingId`, `drawingName`, `lastSyncedAt`, `lastSyncedHash`, `skippedAt`)",
      "Export `readManifest(configPath: string): SyncManifest` — reads and parses JSON, returns empty manifest if file doesn't exist",
      "Export `writeManifest(configPath: string, manifest: SyncManifest): void` — writes formatted JSON",
      "Export `getDrawingEntry(manifest: SyncManifest, filePath: string): DrawingEntry | undefined`",
      "Export `updateDrawingEntry(manifest: SyncManifest, filePath: string, entry: DrawingEntry): void`",
      "Verify TypeScript compilation succeeds"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Implement Mermaid file discovery and content extraction",
    "steps": [
      "Create `~/projects/ExcaliDash/packages/sync-diagrams/src/mermaid.ts`",
      "Export `discoverMermaidFiles(dir: string): string[]` — uses `fs.readdirSync` or `globSync` from `node:fs` to find `*.mermaid.md` files in the given directory",
      "Export `extractMermaidContent(filePath: string): { title: string; mermaidCode: string }` — reads the file, extracts first `#` heading as title, extracts first ```mermaid code block as mermaidCode",
      "Export `computeContentHash(filePath: string): string` — returns `sha256:<hex>` of the file contents using `node:crypto`",
      "Verify TypeScript compilation succeeds"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Implement ExcaliDash API client for sync-diagrams",
    "steps": [
      "Create `~/projects/ExcaliDash/packages/sync-diagrams/src/api.ts`",
      "Export `ExcaliDashClient` class that takes `baseUrl: string` and `apiKey: string` in constructor",
      "Implement `getDrawing(id: string): Promise<{ updatedAt: string; [key: string]: unknown }>` — GET `/drawings/:id` with `X-API-Key` header",
      "Implement `createDrawing(payload: { name: string; elements: unknown[]; appState: Record<string, unknown>; collectionId?: string }): Promise<{ id: string }>` — POST `/drawings`",
      "Implement `updateDrawing(id: string, payload: { name: string; elements: unknown[]; appState: Record<string, unknown> }): Promise<void>` — PUT `/drawings/:id`",
      "Use native `fetch` (Node 18+), no extra HTTP dependencies",
      "Include proper error handling: throw descriptive errors with status codes on non-2xx responses",
      "Verify TypeScript compilation succeeds"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Implement Mermaid-to-Excalidraw conversion wrapper",
    "steps": [
      "Create `~/projects/ExcaliDash/packages/sync-diagrams/src/convert.ts`",
      "Import `parseMermaidToExcalidraw` from `@excalidraw/mermaid-to-excalidraw`",
      "Import `convertToExcalidrawElements` from `@excalidraw/excalidraw`",
      "Export `convertMermaid(mermaidCode: string): Promise<{ elements: unknown[]; files: Record<string, unknown> }>` that chains `parseMermaidToExcalidraw()` → `convertToExcalidrawElements()`",
      "Include the default appState constant from spec: `{ viewBackgroundColor: '#ffffff', currentItemFontFamily: 1, zoom: { value: 1 }, scrollX: 0, scrollY: 0, theme: 'light' }`",
      "Export the default appState for use by the sync orchestrator",
      "Verify TypeScript compilation succeeds"
    ],
    "passes": true
  },
  {
    "category": "backend",
    "description": "Implement sync orchestrator — the main sync loop",
    "steps": [
      "Create `~/projects/ExcaliDash/packages/sync-diagrams/src/sync.ts`",
      "Import all modules: `manifest`, `mermaid`, `api`, `convert`",
      "Export `syncAll(options: { dir: string; configPath: string; excalidashUrl: string; apiKey: string }): Promise<{ synced: number; skipped: number; failed: number }>`",
      "Implementation per spec §4.1:",
      "  1. Read manifest from configPath",
      "  2. Discover *.mermaid.md files in dir",
      "  3. For each file: compute hash, compare to manifest entry",
      "  4. If hash unchanged → skip (increment skipped counter)",
      "  5. If existing drawingId: GET drawing from ExcaliDash, compare updatedAt > lastSyncedAt → skip with log 'human edits detected', set skippedAt",
      "  6. Extract title and mermaid code from file",
      "  7. Convert via parseMermaidToExcalidraw → convertToExcalidrawElements",
      "  8. POST (new) or PUT (existing, not skipped) to ExcaliDash API",
      "  9. On success: update manifest entry (drawingId, drawingName, lastSyncedAt, lastSyncedHash, skippedAt: null)",
      "  10. On failure: log error, leave manifest unchanged, increment failed counter, continue",
      "  11. Write manifest back to configPath",
      "  12. Return counts",
      "Wire up in `src/index.ts`: call `syncAll()` with parsed CLI options, exit 0 if no failures, exit 1 if any failed",
      "Verify TypeScript compilation succeeds"
    ],
    "passes": false
  },
  {
    "category": "integration",
    "description": "Test sync-diagrams end-to-end against local ExcaliDash",
    "steps": [
      "Start local ExcaliDash via `cd ~/projects/ExcaliDash && docker compose up -d` (or `make dev`)",
      "Create a test directory with 2 sample `.mermaid.md` files (flowchart diagrams)",
      "Generate a bcrypt-hashed API key, add to ExcaliDash .env API_KEYS",
      "Create a CI service account user in ExcaliDash",
      "Run `npx tsx ~/projects/ExcaliDash/packages/sync-diagrams/src/index.ts --dir <test-dir>` with EXCALIDASH_URL and EXCALIDASH_API_KEY env vars",
      "Verify both drawings appear in ExcaliDash UI",
      "Re-run with no changes → verify no API calls made, manifest unchanged",
      "Manually edit one drawing in ExcaliDash UI, re-run → verify that drawing is skipped with 'human edits detected' log",
      "Corrupt one file's mermaid syntax, re-run → verify error logged, other file syncs, exit code 1",
      "Verify `.excalidraw-sync.json` is only updated for successfully synced files"
    ],
    "passes": false
  },
  {
    "category": "infrastructure",
    "description": "Create GitHub Actions CI workflow template for consuming repos",
    "steps": [
      "Create `~/projects/ExcaliDash/packages/sync-diagrams/workflow-template/sync-diagrams.yml`",
      "Implement per spec §4.4:",
      "  - Trigger: push to `docs/diagrams/**/*.mermaid.md`",
      "  - Job: checkout, setup-node 20, run `npx @your-org/excalidash-sync --dir docs/diagrams` with EXCALIDASH_URL and EXCALIDASH_API_KEY from secrets",
      "  - Auto-commit `.excalidraw-sync.json` using `stefanzweifel/git-auto-commit-action@v5`",
      "Validate with `actionlint` if available: `actionlint ~/projects/ExcaliDash/packages/sync-diagrams/workflow-template/sync-diagrams.yml`"
    ],
    "passes": false
  },
  {
    "category": "infrastructure",
    "description": "Create AGENTS.md diagram generation snippet for consuming repos",
    "steps": [
      "Create `~/projects/ExcaliDash/packages/sync-diagrams/workflow-template/AGENTS-snippet.md`",
      "Include the AGENTS.md content from spec §11: diagram conventions, flowchart preference, file naming, heading-as-title rule",
      "This file is intended to be copied into consuming repos' AGENTS.md"
    ],
    "passes": false
  },
  {
    "category": "setup",
    "description": "Add README for sync-diagrams package",
    "steps": [
      "Create `~/projects/ExcaliDash/packages/sync-diagrams/README.md`",
      "Document: purpose, installation (`npx @your-org/excalidash-sync`), CLI flags (--dir, --config), required env vars (EXCALIDASH_URL, EXCALIDASH_API_KEY), `.excalidraw-sync.json` manifest format, CI setup instructions (reference workflow template), known limitations (Mermaid diagram type support matrix from spec §6)"
    ],
    "passes": false
  }
]
